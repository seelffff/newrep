# üîß –ê–Ω–∞–ª–∏–∑ –∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º

## üìä –ü–†–û–ë–õ–ï–ú–´ –í–´–Ø–í–õ–ï–ù–´

### –ü—Ä–æ–±–ª–µ–º–∞ 1: –£–±—ã—Ç–æ—á–Ω—ã–µ –ø–æ–∑–∏—Ü–∏–∏

**Root Cause (–Ω–∞–π–¥–µ–Ω–æ –≤ —Å—Ç—Ä–æ–∫–∞—Ö 418-423 `src/trade-executor.ts`):**

```typescript
// ‚ùå –ù–ï–ü–†–ê–í–ò–õ–¨–ù–û - –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏ –ø–æ —Ç–∞–π–º–∞—É—Ç—É –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª–∏—Å—å —Ü–µ–Ω—ã –≤—Ö–æ–¥–∞
this.closePositionPair(
  pairId,
  'TIMEOUT',
  pair.longPosition.entryPrice,  // —Ü–µ–Ω–∞ –ø–æ–∫—É–ø–∫–∏ –Ω–∞ –¥–µ—à–µ–≤–æ–π –±–∏—Ä–∂–µ
  pair.shortPosition.entryPrice  // —Ü–µ–Ω–∞ –ø—Ä–æ–¥–∞–∂–∏ –Ω–∞ –¥–æ—Ä–æ–≥–æ–π –±–∏—Ä–∂–µ
);
```

**–ü–æ—á–µ–º—É —ç—Ç–æ –ø—Ä–∏–≤–æ–¥–∏–ª–æ –∫ —É–±—ã—Ç–∫–∞–º:**

1. LONG –ø–æ–∑–∏—Ü–∏—è –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç—Å—è –ø–æ —Ü–µ–Ω–µ `buyPrice` (–¥–µ—à–µ–≤–∞—è –±–∏—Ä–∂–∞)
2. SHORT –ø–æ–∑–∏—Ü–∏—è –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç—Å—è –ø–æ —Ü–µ–Ω–µ `sellPrice` (–¥–æ—Ä–æ–≥–∞—è –±–∏—Ä–∂–∞)
3. –ü—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏ –ø–æ —Ç–∞–π–º–∞—É—Ç—É –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª–∏—Å—å **—Ç–µ –∂–µ** —Ü–µ–Ω—ã
4. –†–µ–∑—É–ª—å—Ç–∞—Ç: LONG –∑–∞–∫—Ä—ã–≤–∞–µ—Ç—Å—è –ø–æ `buyPrice`, SHORT –∑–∞–∫—Ä—ã–≤–∞–µ—Ç—Å—è –ø–æ `sellPrice`
5. P&L —Ä–∞—Å—á–µ—Ç —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–º –∏–ª–∏ –Ω—É–ª–µ–≤—ã–º

**–ü—Ä–∞–≤–∏–ª—å–Ω–∞—è –ª–æ–≥–∏–∫–∞ –∑–∞–∫—Ä—ã—Ç–∏—è:**
- LONG –∑–∞–∫—Ä—ã–≤–∞–µ—Ç—Å—è –ø–æ —Ç–µ–∫—É—â–µ–π `buyPrice` (—Ç–µ–∫—É—â–µ–π –¥–µ—à–µ–≤–æ–π —Ü–µ–Ω–µ)
- SHORT –∑–∞–∫—Ä—ã–≤–∞–µ—Ç—Å—è –ø–æ —Ç–µ–∫—É—â–µ–π `sellPrice` (—Ç–µ–∫—É—â–µ–π –¥–æ—Ä–æ–≥–æ–π —Ü–µ–Ω–µ)

### –ü—Ä–æ–±–ª–µ–º–∞ 2: –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –ø–æ–¥–¥–µ—Ä–∂–∫–∏ positionTimeoutSeconds = 0

**–¢—Ä–µ–±–æ–≤–∞–Ω–∏–µ:** –ü—Ä–∏ —É—Å—Ç–∞–Ω–æ–≤–∫–µ `positionTimeoutSeconds: 0` –ø–æ–∑–∏—Ü–∏–∏ –¥–æ–ª–∂–Ω—ã –∑–∞–∫—Ä—ã–≤–∞—Ç—å—Å—è **—Ç–æ–ª—å–∫–æ** –ø—Ä–∏ —Å—Ö–æ–∂–¥–µ–Ω–∏–∏ —Å–ø—Ä–µ–¥–∞ (–≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –ø—Ä–∏–±—ã–ª—å).

**–ü—Ä–æ–±–ª–µ–º–∞:** –ü—Ä–∏ –∑–Ω–∞—á–µ–Ω–∏–∏ 0 —Ç–∞–π–º–∞—É—Ç –≤—Å–µ —Ä–∞–≤–Ω–æ —Å—Ä–∞–±–∞—Ç—ã–≤–∞–ª –º–≥–Ω–æ–≤–µ–Ω–Ω–æ.

---

## ‚úÖ –†–ï–®–ï–ù–ò–Ø

### –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ 1: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Ä–µ–∞–ª—å–Ω—ã—Ö —Ä—ã–Ω–æ—á–Ω—ã—Ö —Ü–µ–Ω –ø—Ä–∏ —Ç–∞–π–º–∞—É—Ç–µ

**–ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ `src/trade-executor.ts`:**

1. –î–æ–±–∞–≤–ª–µ–Ω –º–µ—Ç–æ–¥ `setPriceGetter()` –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Ç–µ–∫—É—â–∏—Ö —Ü–µ–Ω:
```typescript
setPriceGetter(fn: (symbol: string) => { buyPrice: number; sellPrice: number } | null): void
```

2. –û–±–Ω–æ–≤–ª–µ–Ω `checkPositionTimeouts()` (—Å—Ç—Ä–æ–∫–∏ 406-447):
```typescript
// –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–∏–µ —Ä—ã–Ω–æ—á–Ω—ã–µ —Ü–µ–Ω—ã
let buyPrice = pair.longPosition.entryPrice;
let sellPrice = pair.shortPosition.entryPrice;

if (this.getPricesFn) {
  const currentPrices = this.getPricesFn(pair.symbol);
  if (currentPrices) {
    buyPrice = currentPrices.buyPrice;
    sellPrice = currentPrices.sellPrice;
  }
}

// –ó–∞–∫—Ä—ã–≤–∞–µ–º –ø–æ —Ç–µ–∫—É—â–∏–º —Ü–µ–Ω–∞–º
this.closePositionPair(pairId, 'TIMEOUT', buyPrice, sellPrice);
```

**–ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ `src/arbitrage-detector.ts`:**

1. –î–æ–±–∞–≤–ª–µ–Ω –º–µ—Ç–æ–¥ `getCurrentPrices()` (—Å—Ç—Ä–æ–∫–∏ 320-341):
```typescript
getCurrentPrices(symbol: string): { buyPrice: number; sellPrice: number } | null {
  const binancePrice = this.binance.getPrice(symbol);
  const mexcPrice = this.mexc.getPrice(MexcFutures.toMexcFormat(symbol));

  if (!binancePrice || !mexcPrice) {
    return null;
  }

  // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –≥–¥–µ –¥–µ—à–µ–≤–ª–µ –ø–æ–∫—É–ø–∞—Ç—å, –≥–¥–µ –¥–æ—Ä–æ–∂–µ –ø—Ä–æ–¥–∞–≤–∞—Ç—å
  let buyPrice: number;
  let sellPrice: number;

  if (binancePrice.ask < mexcPrice.bid) {
    buyPrice = binancePrice.ask;
    sellPrice = mexcPrice.bid;
  } else {
    buyPrice = mexcPrice.ask;
    sellPrice = binancePrice.bid;
  }

  return { buyPrice, sellPrice };
}
```

2. –°–≤—è–∑—ã–≤–∞–Ω–∏–µ —Ñ—É–Ω–∫—Ü–∏–∏ –≤ –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä–µ (—Å—Ç—Ä–æ–∫–∏ 59-60):
```typescript
// –°–≤—è–∑—ã–≤–∞–µ–º —Ñ—É–Ω–∫—Ü–∏—é –ø–æ–ª—É—á–µ–Ω–∏—è —Ü–µ–Ω –¥–ª—è –∑–∞–∫—Ä—ã—Ç–∏—è –ø–æ —Ç–∞–π–º–∞—É—Ç—É
this.tradeExecutor.setPriceGetter((symbol: string) => this.getCurrentPrices(symbol));
```

### –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ 2: –ü–æ–¥–¥–µ—Ä–∂–∫–∞ positionTimeoutSeconds = 0

**–ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ `src/trade-executor.ts`:**

1. –í –º–µ—Ç–æ–¥–µ `openPositionPair()` (—Å—Ç—Ä–æ–∫–∏ 107-109):
```typescript
// –ï—Å–ª–∏ timeout = 0, —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –±–µ—Å–∫–æ–Ω–µ—á–Ω—ã–π —Ç–∞–π–º–∞—É—Ç
const timeoutAt = this.config.trading.positionTimeoutSeconds === 0
  ? Infinity
  : now + this.config.trading.positionTimeoutSeconds * 1000;
```

2. –í –º–µ—Ç–æ–¥–µ `start()` (—Å—Ç—Ä–æ–∫–∏ 67-73):
```typescript
if (this.config.trading.positionTimeoutSeconds === 0) {
  this.logger.info(`–¢–∞–π–º–∞—É—Ç –ø–æ–∑–∏—Ü–∏–∏: –û–¢–ö–õ–Æ–ß–ï–ù (–∑–∞–∫—Ä—ã—Ç–∏–µ —Ç–æ–ª—å–∫–æ –ø—Ä–∏ —Å—Ö–æ–∂–¥–µ–Ω–∏–∏ —Å–ø—Ä–µ–¥–∞)`);
} else {
  this.logger.info(
    `–¢–∞–π–º–∞—É—Ç –ø–æ–∑–∏—Ü–∏–∏: ${this.config.trading.positionTimeoutSeconds}s (${(this.config.trading.positionTimeoutSeconds / 60).toFixed(1)} –º–∏–Ω)`
  );
}
```

3. –í –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–∏ –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ –ø–æ–∑–∏—Ü–∏–∏ (—Å—Ç—Ä–æ–∫–∏ 172-179):
```typescript
if (timeoutAt === Infinity) {
  this.logger.info(`  ‚Ä¢ –¢–∞–π–º–∞—É—Ç –∑–∞–∫—Ä—ã—Ç–∏—è: –û–¢–ö–õ–Æ–ß–ï–ù`);
  this.logger.info(`  ‚Ä¢ –ó–∞–∫—Ä—ã—Ç–∏–µ: —Ç–æ–ª—å–∫–æ –ø—Ä–∏ —Å—Ö–æ–∂–¥–µ–Ω–∏–∏ —Å–ø—Ä–µ–¥–∞ (–≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –ø—Ä–∏–±—ã–ª—å)`);
} else {
  const timeoutTimeStr = new Date(timeoutAt).toISOString();
  this.logger.info(`  ‚Ä¢ –¢–∞–π–º–∞—É—Ç –∑–∞–∫—Ä—ã—Ç–∏—è: ${timeoutTimeStr}`);
  this.logger.info(`  ‚Ä¢ –ú–∞–∫—Å. –≤—Ä–µ–º—è –∂–∏–∑–Ω–∏: ${this.config.trading.positionTimeoutSeconds}s (...)`);
}
```

---

## üéØ –†–ï–ó–£–õ–¨–¢–ê–¢–´

### –¢–µ–ø–µ—Ä—å –ø–æ–∑–∏—Ü–∏–∏:

‚úÖ **–ó–∞–∫—Ä—ã–≤–∞—é—Ç—Å—è –ø–æ —Ä–µ–∞–ª—å–Ω—ã–º —Ä—ã–Ω–æ—á–Ω—ã–º —Ü–µ–Ω–∞–º** –ø—Ä–∏ —Ç–∞–π–º–∞—É—Ç–µ
‚úÖ **–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç —Ä–µ–∂–∏–º positionTimeoutSeconds = 0** (–∑–∞–∫—Ä—ã—Ç–∏–µ —Ç–æ–ª—å–∫–æ –ø—Ä–∏ —Å—Ö–æ–∂–¥–µ–Ω–∏–∏ —Å–ø—Ä–µ–¥–∞)
‚úÖ **–õ–æ–≥–∏—Ä—É—é—Ç —Ç–µ–∫—É—â–∏–µ —Ü–µ–Ω—ã** –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏ –ø–æ —Ç–∞–π–º–∞—É—Ç—É
‚úÖ **–ü–æ–∫–∞–∑—ã–≤–∞—é—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π P&L** –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ä–µ–∞–ª—å–Ω—ã—Ö —Ü–µ–Ω

### –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:

```json
{
  "trading": {
    "positionTimeoutSeconds": 0,  // –ó–∞–∫—Ä—ã—Ç–∏–µ —Ç–æ–ª—å–∫–æ –ø—Ä–∏ —Å—Ö–æ–∂–¥–µ–Ω–∏–∏ —Å–ø—Ä–µ–¥–∞
    "closeOnSpreadConvergence": true,
    "minProfitToClosePercent": 0.3  // –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –ø—Ä–∏–±—ã–ª—å –¥–ª—è –∑–∞–∫—Ä—ã—Ç–∏—è
  }
}
```

–ü—Ä–∏ —Ç–∞–∫–∏—Ö –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö –ø–æ–∑–∏—Ü–∏–∏ –±—É–¥—É—Ç –∑–∞–∫—Ä—ã–≤–∞—Ç—å—Å—è **—Ç–æ–ª—å–∫–æ** –∫–æ–≥–¥–∞:
1. –°–ø—Ä–µ–¥ —Å—Ö–æ–¥–∏—Ç—Å—è (—Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è –º–µ–Ω—å—à–µ `minSpreadPercent`)
2. –¢–µ–∫—É—â–∞—è –ø—Ä–∏–±—ã–ª—å >= `minProfitToClosePercent`

**–≠—Ç–æ –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç –ø—Ä–∏–±—ã–ª—å–Ω–æ—Å—Ç—å –∫–∞–∂–¥–æ–π –∑–∞–∫—Ä—ã—Ç–æ–π —Å–¥–µ–ª–∫–∏.**

---

## üìù –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–µ—Ç–∞–ª–∏

### –ê–ª–≥–æ—Ä–∏—Ç–º –∑–∞–∫—Ä—ã—Ç–∏—è –ø–æ —Å—Ö–æ–∂–¥–µ–Ω–∏—é —Å–ø—Ä–µ–¥–∞:

1. –ü—Ä–∏ –∫–∞–∂–¥–æ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —Ü–µ–Ω –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è `updatePositionSpread()`
2. –í—ã—á–∏—Å–ª—è–µ—Ç—Å—è —Ç–µ–∫—É—â–∏–π —Å–ø—Ä–µ–¥
3. –ï—Å–ª–∏ `currentSpread < minSpreadPercent`:
   - –í—ã—á–∏—Å–ª—è–µ—Ç—Å—è —Ç–µ–∫—É—â–∞—è –ø—Ä–∏–±—ã–ª—å (LONG P&L + SHORT P&L) / 2
   - –ï—Å–ª–∏ `totalPnl >= minProfitToClosePercent` ‚Üí –∑–∞–∫—Ä—ã–≤–∞–µ–º –ø–æ–∑–∏—Ü–∏–∏
4. –ó–∞–∫—Ä—ã—Ç–∏–µ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –ø–æ **—Ç–µ–∫—É—â–∏–º —Ä—ã–Ω–æ—á–Ω—ã–º —Ü–µ–Ω–∞–º**, –∞ –Ω–µ –ø–æ —Ü–µ–Ω–∞–º –≤—Ö–æ–¥–∞

### –ü—Ä–∏–º–µ—Ä —Ä–∞—Å—á–µ—Ç–∞ P&L:

**–û—Ç–∫—Ä—ã—Ç–∏–µ:**
- LONG @ 100 USDT (Binance)
- SHORT @ 101 USDT (MEXC)
- –°–ø—Ä–µ–¥: 1%

**–ó–∞–∫—Ä—ã—Ç–∏–µ (—Å–ø—Ä–µ–¥ —Å–æ—à–µ–ª—Å—è):**
- –¢–µ–∫—É—â–∞—è buyPrice @ 100.3 USDT
- –¢–µ–∫—É—â–∞—è sellPrice @ 100.4 USDT
- –°–ø—Ä–µ–¥: 0.1%

**P&L:**
- LONG: (100.3 - 100) / 100 = +0.3%
- SHORT: (101 - 100.4) / 101 = +0.59%
- **–û–±—â–∞—è –ø—Ä–∏–±—ã–ª—å: (0.3 + 0.59) / 2 = +0.45%**

---

## üîç –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞

–ï—Å–ª–∏ –ø–æ–∑–∏—Ü–∏–∏ –≤—Å–µ –µ—â–µ —É–±—ã—Ç–æ—á–Ω—ã–µ, –ø—Ä–æ–≤–µ—Ä—å—Ç–µ:

1. **–õ–æ–≥–∏ –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏ –ø–æ —Ç–∞–π–º–∞—É—Ç—É:**
   - –î–æ–ª–∂–Ω—ã –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å "–¢–µ–∫—É—â–∏–µ —Ä—ã–Ω–æ—á–Ω—ã–µ —Ü–µ–Ω—ã –¥–ª—è [SYMBOL]"
   - –ï—Å–ª–∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç "–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å —Ç–µ–∫—É—â–∏–µ —Ü–µ–Ω—ã" - –ø—Ä–æ–±–ª–µ–º–∞ —Å WebSocket

2. **–õ–æ–≥–∏ –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏:**
   - –î–æ–ª–∂–Ω—ã –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ buyExchange/sellExchange

3. **Excel –æ—Ç—á–µ—Ç:**
   - –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–ª–æ–Ω–∫–∏ "LONG –≤—Ö–æ–¥/–≤—ã—Ö–æ–¥" –∏ "SHORT –≤—Ö–æ–¥/–≤—ã—Ö–æ–¥"
   - –£–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ —Ü–µ–Ω—ã –≤—ã—Ö–æ–¥–∞ –æ—Ç–ª–∏—á–∞—é—Ç—Å—è –æ—Ç —Ü–µ–Ω –≤—Ö–æ–¥–∞

4. **Config.json:**
   - `closeOnSpreadConvergence: true`
   - `minProfitToClosePercent: 0.3` (–∏–ª–∏ –≤—ã—à–µ)
   - `positionTimeoutSeconds: 0` –¥–ª—è —Ç–æ–ª—å–∫–æ-–ø—Ä–∏–±—ã–ª—å–Ω–æ–≥–æ —Ä–µ–∂–∏–º–∞