import type {
  Position,
  PositionPair,
  ArbitrageOpportunity,
  SkippedOpportunity,
} from './types/exchange.js';
import type { Config } from './types/config.js';
import { Logger } from './utils/logger.js';
import { randomUUID } from 'crypto';

/**
 * –ö–ª–∞—Å—Å –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ç–æ—Ä–≥–æ–≤—ã–º–∏ –ø–æ–∑–∏—Ü–∏—è–º–∏ (—Ä–µ–∞–ª—å–Ω—ã–º–∏ –∏–ª–∏ —Ç–µ—Å—Ç–æ–≤—ã–º–∏)
 */
export class TradeExecutor {
  private config: Config;
  private logger: Logger;
  private openPositions: Map<string, PositionPair> = new Map();
  private closedPositions: PositionPair[] = [];
  private skippedOpportunities: SkippedOpportunity[] = [];
  private checkInterval: NodeJS.Timeout | null = null;
  private getPricesFn?: (symbol: string) => { buyPrice: number; sellPrice: number } | null;
  private currentBalance: number; // –¢–µ–∫—É—â–∏–π –±–∞–ª–∞–Ω—Å (—Ç–µ—Å—Ç–æ–≤—ã–π –∏–ª–∏ —Ä–µ–∞–ª—å–Ω—ã–π)
  private initialBalance: number; // –ù–∞—á–∞–ª—å–Ω—ã–π –±–∞–ª–∞–Ω—Å –¥–ª—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏

  // –¢–µ—Å—Ç–æ–≤–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
  private testStats = {
    totalTrades: 0,
    profitableTrades: 0,
    losingTrades: 0,
    totalProfit: 0,
    totalLoss: 0,
  };

  constructor(config: Config, logger?: Logger) {
    this.config = config;
    this.logger = logger || new Logger(config.notifications.coloredOutput);
  }

  /**
   * –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Ñ—É–Ω–∫—Ü–∏—é –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Ç–µ–∫—É—â–∏—Ö —Ü–µ–Ω (–∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –∑–∞–∫—Ä—ã—Ç–∏—è –ø–æ —Ç–∞–π–º–∞—É—Ç—É)
   */
  setPriceGetter(fn: (symbol: string) => { buyPrice: number; sellPrice: number } | null): void {
    this.getPricesFn = fn;
  }

  /**
   * –ó–∞–ø—É—Å—Ç–∏—Ç—å –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –æ—Ç–∫—Ä—ã—Ç—ã—Ö –ø–æ–∑–∏—Ü–∏–π
   */
  start(): void {
    if (!this.config.trading.enabled) {
      this.logger.info('–¢–æ—Ä–≥–æ–≤–ª—è –æ—Ç–∫–ª—é—á–µ–Ω–∞ –≤ –∫–æ–Ω—Ñ–∏–≥–µ. –¢–æ–ªÔøΩÔøΩ–∫–æ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —Å–ø—Ä–µ–¥–æ–≤.');
      return;
    }

    const mode = this.config.trading.testMode ? '–¢–ï–°–¢–û–í–´–ô' : '–†–ï–ê–õ–¨–ù–´–ô';
    this.logger.warn(`‚ö†Ô∏è  –¢–û–†–ì–û–í–õ–Ø –í–ö–õ–Æ–ß–ï–ù–ê! –†–µ–∂–∏–º: ${mode}`);

    if (!this.config.trading.testMode) {
      this.logger.warn(
        'üî¥ –í–ù–ò–ú–ê–ù–ò–ï: –†–µ–∞–ª—å–Ω–∞—è —Ç–æ—Ä–≥–æ–≤–ª—è —Å —Ä–µ–∞–ª—å–Ω—ã–º–∏ –¥–µ–Ω—å–≥–∞–º–∏! –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ API –∫–ª—é—á–∏ –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã!'
      );
    }

    this.logger.info(`–ú–∞–∫—Å–∏–º—É–º –æ—Ç–∫—Ä—ã—Ç—ã—Ö –ø–æ–∑–∏—Ü–∏–π: ${this.config.trading.maxOpenPositions}`);
    this.logger.info(
      `–†–∞–∑–º–µ—Ä –ø–æ–∑–∏—Ü–∏–∏: $${this.config.trading.positionSizeUSD} –Ω–∞ –∫–∞–∂–¥—É—é –±–∏—Ä–∂—É`
    );
    this.logger.info(`–ü–ª–µ—á–æ: ${this.config.trading.leverage}x`);
    this.logger.info(`–†–µ–∂–∏–º –º–∞—Ä–∂–∏: ${this.config.trading.marginMode}`);

    if (this.config.trading.positionTimeoutSeconds === 0) {
      this.logger.info(`–¢–∞–π–º–∞—É—Ç –ø–æ–∑–∏—Ü–∏–∏: –û–¢–ö–õ–Æ–ß–ï–ù (–∑–∞–∫—Ä—ã—Ç–∏–µ —Ç–æ–ª—å–∫–æ –ø—Ä–∏ —Å—Ö–æ–∂–¥–µ–Ω–∏–∏ —Å–ø—Ä–µ–¥–∞)`);
    } else {
      this.logger.info(
        `–¢–∞–π–º–∞—É—Ç –ø–æ–∑–∏—Ü–∏–∏: ${this.config.trading.positionTimeoutSeconds}s (${(this.config.trading.positionTimeoutSeconds / 60).toFixed(1)} –º–∏–Ω)`
      );
    }
    this.logger.separator();

    // –ó–∞–ø—É—Å–∫–∞–µ–º –ø—Ä–æ–≤–µ—Ä–∫—É —Ç–∞–π–º–∞—É—Ç–æ–≤ –∫–∞–∂–¥—ã–µ 10 —Å–µ–∫—É–Ω–¥
    this.checkInterval = setInterval(() => {
      this.checkPositionTimeouts();
    }, 10000);
  }

  /**
   * –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –º–æ–∂–Ω–æ –ª–∏ –æ—Ç–∫—Ä—ã—Ç—å –Ω–æ–≤—É—é –ø–æ–∑–∏—Ü–∏—é
   */
  canOpenNewPosition(): boolean {
    if (!this.config.trading.enabled) {
      return false;
    }

    return this.openPositions.size < this.config.trading.maxOpenPositions;
  }

  /**
   * –û—Ç–∫—Ä—ã—Ç—å –ø–∞—Ä—É –ø–æ–∑–∏—Ü–∏–π (LONG + SHORT) –Ω–∞ –æ—Å–Ω–æ–≤–µ –∞—Ä–±–∏—Ç—Ä–∞–∂–Ω–æ–π –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏
   */
  async openPositionPair(opportunity: ArbitrageOpportunity): Promise<void> {
    if (!this.canOpenNewPosition()) {
      this.logger.warn(
        `–î–æ—Å—Ç–∏–≥–Ω—É—Ç –ª–∏–º–∏—Ç –æ—Ç–∫—Ä—ã—Ç—ã—Ö –ø–æ–∑–∏—Ü–∏–π (${this.openPositions.size}/${this.config.trading.maxOpenPositions})`
      );
      return;
    }

    const pairId = randomUUID();
    const now = Date.now();
    // –ï—Å–ª–∏ timeout = 0, —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –±–µ—Å–∫–æ–Ω–µ—á–Ω—ã–π —Ç–∞–π–º–∞—É—Ç (–∑–∞–∫—Ä—ã—Ç–∏–µ —Ç–æ–ª—å–∫–æ –ø—Ä–∏ —Å—Ö–æ–∂–¥–µ–Ω–∏–∏ —Å–ø—Ä–µ–¥–∞)
    const timeoutAt = this.config.trading.positionTimeoutSeconds === 0
      ? Infinity
      : now + this.config.trading.positionTimeoutSeconds * 1000;

    // –°–æ–∑–¥–∞–µ–º LONG –ø–æ–∑–∏—Ü–∏—é (–ø–æ–∫—É–ø–∞–µ–º –Ω–∞ –¥–µ—à–µ–≤–æ–π –±–∏—Ä–∂–µ)
    const longPosition: Position = {
      id: randomUUID(),
      symbol: opportunity.symbol,
      exchange: opportunity.buyExchange,
      side: 'LONG',
      entryPrice: opportunity.buyPrice,
      quantity: this.calculateQuantity(opportunity.buyPrice),
      sizeUSD: this.config.trading.positionSizeUSD,
      leverage: this.config.trading.leverage,
      status: 'OPEN',
      openTime: now,
    };

    // –°–æ–∑–¥–∞–µ–º SHORT –ø–æ–∑–∏—Ü–∏—é (–ø—Ä–æ–¥–∞–µ–º –Ω–∞ –¥–æ—Ä–æ–≥–æ–π –±–∏—Ä–∂–µ)
    const shortPosition: Position = {
      id: randomUUID(),
      symbol: opportunity.symbol,
      exchange: opportunity.sellExchange,
      side: 'SHORT',
      entryPrice: opportunity.sellPrice,
      quantity: this.calculateQuantity(opportunity.sellPrice),
      sizeUSD: this.config.trading.positionSizeUSD,
      leverage: this.config.trading.leverage,
      status: 'OPEN',
      openTime: now,
    };

    const positionPair: PositionPair = {
      id: pairId,
      symbol: opportunity.symbol,
      longPosition,
      shortPosition,
      openSpread: opportunity.spreadPercent,
      expectedProfit: opportunity.profitPercent,
      status: 'OPEN',
      openTime: now,
      timeoutAt,
    };

    // –í —Ç–µ—Å—Ç–æ–≤–æ–º —Ä–µ–∂–∏–º–µ –ø—Ä–æ—Å—Ç–æ –∏–º–∏—Ç–∏—Ä—É–µ–º
    if (this.config.trading.testMode) {
      this.simulateOpenPosition(positionPair);
    } else {
      // –†–µ–∞–ª—å–Ω–∞—è —Ç–æ—Ä–≥–æ–≤–ª—è (TODO: —Ä–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å API –≤—ã–∑–æ–≤—ã)
      await this.realOpenPosition(positionPair);
    }

    this.openPositions.set(pairId, positionPair);

    // –î–µ—Ç–∞–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
    const openTimeStr = new Date(now).toISOString();

    this.logger.separator();
    this.logger.success(`‚úì –û–¢–ö–†–´–¢–ê –ü–ê–†–ê –ü–û–ó–ò–¶–ò–ô #${this.openPositions.size}`);
    this.logger.separator();
    this.logger.info(`üìä –û–±—â–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è:`);
    this.logger.info(`  ‚Ä¢ Symbol: ${opportunity.symbol}`);
    this.logger.info(`  ‚Ä¢ Pair ID: ${pairId}`);
    this.logger.info(`  ‚Ä¢ –í—Ä–µ–º—è –æ—Ç–∫—Ä—ã—Ç–∏—è: ${openTimeStr}`);

    if (timeoutAt === Infinity) {
      this.logger.info(`  ‚Ä¢ –¢–∞–π–º–∞—É—Ç –∑–∞–∫—Ä—ã—Ç–∏—è: –û–¢–ö–õ–Æ–ß–ï–ù`);
      this.logger.info(`  ‚Ä¢ –ó–∞–∫—Ä—ã—Ç–∏–µ: —Ç–æ–ª—å–∫–æ –ø—Ä–∏ —Å—Ö–æ–∂–¥–µ–Ω–∏–∏ —Å–ø—Ä–µ–¥–∞ (–≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –ø—Ä–∏–±—ã–ª—å)`);
    } else {
      const timeoutTimeStr = new Date(timeoutAt).toISOString();
      this.logger.info(`  ‚Ä¢ –¢–∞–π–º–∞—É—Ç –∑–∞–∫—Ä—ã—Ç–∏—è: ${timeoutTimeStr}`);
      this.logger.info(`  ‚Ä¢ –ú–∞–∫—Å. –≤—Ä–µ–º—è –∂–∏–∑–Ω–∏: ${this.config.trading.positionTimeoutSeconds}s (${(this.config.trading.positionTimeoutSeconds / 60).toFixed(1)} –º–∏–Ω)`);
    }

    this.logger.separator();
    this.logger.info(`üìà LONG –ø–æ–∑–∏—Ü–∏—è (–ø–æ–∫—É–ø–∫–∞ –Ω–∞ –¥–µ—à–µ–≤–æ–π –±–∏—Ä–∂–µ):`);
    this.logger.info(`  ‚Ä¢ –ë–∏—Ä–∂–∞: ${opportunity.buyExchange.toUpperCase()}`);
    this.logger.info(`  ‚Ä¢ –¶–µ–Ω–∞ –≤—Ö–æ–¥–∞: ${opportunity.buyPrice.toFixed(4)} USDT`);
    this.logger.info(`  ‚Ä¢ –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ: ${longPosition.quantity.toFixed(6)} –∫–æ–Ω—Ç—Ä–∞–∫—Ç–æ–≤`);
    this.logger.info(`  ‚Ä¢ –†–∞–∑–º–µ—Ä –ø–æ–∑–∏—Ü–∏–∏: $${this.config.trading.positionSizeUSD} USD`);
    this.logger.info(`  ‚Ä¢ –ü–ª–µ—á–æ: ${this.config.trading.leverage}x`);
    this.logger.info(`  ‚Ä¢ –†–µ–∂–∏–º –º–∞—Ä–∂–∏: ${this.config.trading.marginMode}`);
    this.logger.info(`  ‚Ä¢ Position ID: ${longPosition.id}`);
    this.logger.separator();
    this.logger.info(`üìâ SHORT –ø–æ–∑–∏—Ü–∏—è (–ø—Ä–æ–¥–∞–∂–∞ –Ω–∞ –¥–æ—Ä–æ–≥–æ–π –±–∏—Ä–∂–µ):`);
    this.logger.info(`  ‚Ä¢ –ë–∏—Ä–∂–∞: ${opportunity.sellExchange.toUpperCase()}`);
    this.logger.info(`  ‚Ä¢ –¶–µ–Ω–∞ –≤—Ö–æ–¥–∞: ${opportunity.sellPrice.toFixed(4)} USDT`);
    this.logger.info(`  ‚Ä¢ –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ: ${shortPosition.quantity.toFixed(6)} –∫–æ–Ω—Ç—Ä–∞–∫—Ç–æ–≤`);
    this.logger.info(`  ‚Ä¢ –†–∞–∑–º–µ—Ä –ø–æ–∑–∏—Ü–∏–∏: $${this.config.trading.positionSizeUSD} USD`);
    this.logger.info(`  ‚Ä¢ –ü–ª–µ—á–æ: ${this.config.trading.leverage}x`);
    this.logger.info(`  ‚Ä¢ –†–µ–∂–∏–º –º–∞—Ä–∂–∏: ${this.config.trading.marginMode}`);
    this.logger.info(`  ‚Ä¢ Position ID: ${shortPosition.id}`);
    this.logger.separator();
    this.logger.info(`üí∞ –ü—Ä–æ–≥–Ω–æ–∑ –ø—Ä–∏–±—ã–ª–∏:`);
    this.logger.info(`  ‚Ä¢ –°–ø—Ä–µ–¥ –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏: ${opportunity.spreadPercent.toFixed(2)}%`);
    this.logger.info(`  ‚Ä¢ –ü—Ä–∏–±—ã–ª—å –ø–æ—Å–ª–µ –∫–æ–º–∏—Å—Å–∏–π: ${opportunity.profitPercent.toFixed(2)}%`);
    this.logger.info(`  ‚Ä¢ –û–∂–∏–¥–∞–µ–º–∞—è –ø—Ä–∏–±—ã–ª—å: $${((opportunity.profitPercent / 100) * this.config.trading.positionSizeUSD * 2).toFixed(2)} USD`);
    this.logger.info(`  ‚Ä¢ –û–±—â–∏–π –∫–∞–ø–∏—Ç–∞–ª –≤ –ø–æ–∑–∏—Ü–∏—è—Ö: $${this.config.trading.positionSizeUSD * 2} USD`);
    this.logger.separator();
  }

  /**
   * –ò–º–∏—Ç–∞—Ü–∏—è –æ—Ç–∫—Ä—ã—Ç–∏—è –ø–æ–∑–∏—Ü–∏–∏ (—Ç–µ—Å—Ç–æ–≤—ã–π —Ä–µ–∂–∏–º)
   */
  private simulateOpenPosition(pair: PositionPair): void {
    this.logger.info(
      `üß™ [TEST] –ò–º–∏—Ç–∞—Ü–∏—è –æ—Ç–∫—Ä—ã—Ç–∏—è –ø–æ–∑–∏—Ü–∏–π –¥–ª—è ${pair.symbol}...`
    );
    // –í —Ç–µ—Å—Ç–æ–≤–æ–º —Ä–µ–∂–∏–º–µ –Ω–∏—á–µ–≥–æ –Ω–µ –¥–µ–ª–∞–µ–º —Å —Ä–µ–∞–ª—å–Ω—ã–º–∏ API
  }

  /**
   * –†–µ–∞–ª—å–Ω–æ–µ –æ—Ç–∫—Ä—ã—Ç–∏–µ –ø–æ–∑–∏—Ü–∏–π —á–µ—Ä–µ–∑ API
   */
  private async realOpenPosition(pair: PositionPair): Promise<void> {
    this.logger.warn(
      `üî¥ [REAL] –û—Ç–∫—Ä—ã—Ç–∏–µ —Ä–µ–∞–ª—å–Ω—ã—Ö –ø–æ–∑–∏—Ü–∏–π –¥–ª—è ${pair.symbol}...`
    );

    // TODO: –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å —Ä–µ–∞–ª—å–Ω—ã–µ API –≤—ã–∑–æ–≤—ã –∫ –±–∏—Ä–∂–∞–º
    // 1. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å leverage
    // 2. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å margin mode
    // 3. –û—Ç–∫—Ä—ã—Ç—å LONG –ø–æ–∑–∏—Ü–∏—é –Ω–∞ buyExchange
    // 4. –û—Ç–∫—Ä—ã—Ç—å SHORT –ø–æ–∑–∏—Ü–∏—é –Ω–∞ sellExchange

    throw new Error('–†–µ–∞–ª—å–Ω–∞—è —Ç–æ—Ä–≥–æ–≤–ª—è –ø–æ–∫–∞ –Ω–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞! –ò—Å–ø–æ–ª—å–∑—É–π testMode: true');
  }

  /**
   * –û–±–Ω–æ–≤–∏—Ç—å —Ç–µ–∫—É—â–∏–π —Å–ø—Ä–µ–¥ –¥–ª—è –æ—Ç–∫—Ä—ã—Ç—ã—Ö –ø–æ–∑–∏—Ü–∏–π
   */
  updatePositionSpread(
    symbol: string,
    currentBuyPrice: number,
    currentSellPrice: number
  ): void {
    for (const [pairId, pair] of this.openPositions.entries()) {
      if (pair.symbol === symbol && pair.status === 'OPEN') {
        // –í—ã—á–∏—Å–ª—è–µ–º —Ç–µ–∫—É—â–∏–π —Å–ø—Ä–µ–¥
        const currentSpread = ((currentSellPrice - currentBuyPrice) / currentBuyPrice) * 100;
        pair.currentSpread = currentSpread;

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º —É—Å–ª–æ–≤–∏—è –∑–∞–∫—Ä—ã—Ç–∏—è
        if (this.config.trading.closeOnSpreadConvergence) {
          // –ï—Å–ª–∏ —Å–ø—Ä–µ–¥ —Å—Ö–æ–¥–∏—Ç—Å—è (—Å—Ç–∞–ª –º–µ–Ω—å—à–µ –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–≥–æ –ø–æ—Ä–æ–≥–∞)
          if (currentSpread < this.config.arbitrage.minSpreadPercent) {
            // –íÔøΩÔøΩ—á–∏—Å–ª—è–µ–º —Ç–µ–∫—É—â—É—é –ø—Ä–∏–±—ã–ª—å
            const longPnl =
              ((currentBuyPrice - pair.longPosition.entryPrice) /
                pair.longPosition.entryPrice) *
              100;
            const shortPnl =
              ((pair.shortPosition.entryPrice - currentSellPrice) /
                pair.shortPosition.entryPrice) *
              100;
            const totalPnl = (longPnl + shortPnl) / 2;

            // –ó–∞–∫—Ä—ã–≤–∞–µ–º –µ—Å–ª–∏ –ø—Ä–∏–±—ã–ª—å –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–∞—è
            if (totalPnl >= this.config.trading.minProfitToClosePercent) {
              this.logger.info(
                `–°–ø—Ä–µ–¥ —Å–æ—à–µ–ª—Å—è –¥–ª—è ${symbol}, –ø—Ä–∏–±—ã–ª—å ${totalPnl.toFixed(2)}% - –∑–∞–∫—Ä—ã–≤–∞–µ–º...`
              );
              this.closePositionPair(pairId, 'SPREAD_CONVERGENCE', currentBuyPrice, currentSellPrice);
            }
          }
        }
      }
    }
  }

  /**
   * –ó–∞–∫—Ä—ã—Ç—å –ø–∞—Ä—É –ø–æ–∑–∏—Ü–∏–π
   */
  private closePositionPair(
    pairId: string,
    reason: 'SPREAD_CONVERGENCE' | 'TIMEOUT' | 'MANUAL',
    currentBuyPrice: number,
    currentSellPrice: number
  ): void {
    const pair = this.openPositions.get(pairId);
    if (!pair) return;

    const now = Date.now();

    // –í—ã—á–∏—Å–ª—è–µ–º PnL –¥ÔøΩÔøΩ—è –∫–∞–∂–¥–æ–π –ø–æ–∑–∏—Ü–∏–∏
    const longPnl =
      ((currentBuyPrice - pair.longPosition.entryPrice) /
        pair.longPosition.entryPrice) *
      100;
    const shortPnl =
      ((pair.shortPosition.entryPrice - currentSellPrice) /
        pair.shortPosition.entryPrice) *
      100;

    const totalPnlPercent = (longPnl + shortPnl) / 2;
    const totalPnlUSD =
      (totalPnlPercent / 100) * this.config.trading.positionSizeUSD * 2; // *2 –ø–æ—Ç–æ–º—É —á—Ç–æ –¥–≤–µ –ø–æ–∑–∏—Ü–∏–∏

    // –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ–∑–∏—Ü–∏–∏
    pair.longPosition.exitPrice = currentBuyPrice;
    pair.longPosition.closeTime = now;
    pair.longPosition.status = reason === 'TIMEOUT' ? 'TIMEOUT_CLOSED' : 'CLOSED';
    pair.longPosition.pnl = (longPnl / 100) * this.config.trading.positionSizeUSD;
    pair.longPosition.pnlPercent = longPnl;

    pair.shortPosition.exitPrice = currentSellPrice;
    pair.shortPosition.closeTime = now;
    pair.shortPosition.status = reason === 'TIMEOUT' ? 'TIMEOUT_CLOSED' : 'CLOSED';
    pair.shortPosition.pnl = (shortPnl / 100) * this.config.trading.positionSizeUSD;
    pair.shortPosition.pnlPercent = shortPnl;

    pair.status = reason === 'TIMEOUT' ? 'TIMEOUT_CLOSED' : 'CLOSED';
    pair.closeTime = now;
    pair.actualProfit = totalPnlPercent;

    // –ò–º–∏—Ç–∞—Ü–∏—è –∏–ª–∏ —Ä–µ–∞–ª—å–Ω–æ–µ –∑–∞–∫—Ä—ã—Ç–∏–µ
    if (this.config.trading.testMode) {
      this.simulateClosePosition(pair);
    } else {
      // TODO: –†–µ–∞–ª—å–Ω–æ–µ –∑–∞–∫—Ä—ã—Ç–∏–µ —á–µ—Ä–µ–∑ API
      this.logger.warn(`üî¥ [REAL] –ó–∞–∫—Ä—ã—Ç–∏–µ —Ä–µ–∞–ª—å–Ω—ã—Ö –ø–æ–∑–∏—Ü–∏–π –¥–ª—è ${pair.symbol}...`);
    }

    // –ü–µ—Ä–µ–º–µ—â–∞–µ–º –≤ –∑–∞–∫—Ä—ã—Ç—ã–µ
    this.openPositions.delete(pairId);
    this.closedPositions.push(pair);

    // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
    this.testStats.totalTrades++;
    if (totalPnlUSD > 0) {
      this.testStats.profitableTrades++;
      this.testStats.totalProfit += totalPnlUSD;
    } else {
      this.testStats.losingTrades++;
      this.testStats.totalLoss += Math.abs(totalPnlUSD);
    }

    // –î–µ—Ç–∞–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–∫—Ä—ã—Ç–∏—è
    const reasonText =
      reason === 'TIMEOUT'
        ? '–¢–∞–π–º–∞—É—Ç'
        : reason === 'SPREAD_CONVERGENCE'
        ? '–°—Ö–æ–∂–¥–µ–Ω–∏–µ —Å–ø—Ä–µ–¥–∞'
        : '–í—Ä—É—á–Ω—É—é';

    const closeTimeStr = new Date(now).toISOString();
    const openTimeStr = new Date(pair.openTime).toISOString();
    const holdTimeSeconds = ((now - pair.openTime) / 1000).toFixed(0);
    const holdTimeMinutes = ((now - pair.openTime) / 60000).toFixed(1);
    const isProfitable = totalPnlUSD > 0;

    this.logger.separator('‚ïê');
    this.logger[isProfitable ? 'success' : 'warn'](
      `üîí –ó–ê–ö–†–´–¢–ê –ü–ê–†–ê –ü–û–ó–ò–¶–ò–ô #${this.closedPositions.length} (${reasonText})`
    );
    this.logger.separator('‚ïê');
    this.logger.info(`üìä –û–±—â–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è:`);
    this.logger.info(`  ‚Ä¢ Symbol: ${pair.symbol}`);
    this.logger.info(`  ‚Ä¢ Pair ID: ${pair.id}`);
    this.logger.info(`  ‚Ä¢ –í—Ä–µ–º—è –æ—Ç–∫—Ä—ã—Ç–∏—è: ${openTimeStr}`);
    this.logger.info(`  ‚Ä¢ –í—Ä–µ–º—è –∑–∞–∫—Ä—ã—Ç–∏—è: ${closeTimeStr}`);
    this.logger.info(`  ‚Ä¢ –í—Ä–µ–º—è —É–¥–µ—Ä–∂–∞–Ω–∏—è: ${holdTimeSeconds}s (${holdTimeMinutes} –º–∏–Ω)`);
    this.logger.separator();
    this.logger.info(`üìà LONG –ø–æ–∑–∏—Ü–∏—è (${pair.longPosition.exchange.toUpperCase()}):`);
    this.logger.info(`  ‚Ä¢ –¶–µ–Ω–∞ –≤—Ö–æ–¥–∞: ${pair.longPosition.entryPrice.toFixed(4)} USDT`);
    this.logger.info(`  ‚Ä¢ –¶–µ–Ω–∞ –≤—ã—Ö–æ–¥–∞: ${currentBuyPrice.toFixed(4)} USDT`);
    this.logger.info(`  ‚Ä¢ –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ: ${pair.longPosition.quantity.toFixed(6)} –∫–æ–Ω—Ç—Ä–∞–∫—Ç–æ–≤`);
    this.logger.info(`  ‚Ä¢ P&L: ${longPnl.toFixed(2)}% ($${pair.longPosition.pnl?.toFixed(2)} USD)`);
    this.logger.separator();
    this.logger.info(`üìâ SHORT –ø–æ–∑–∏—Ü–∏—è (${pair.shortPosition.exchange.toUpperCase()}):`);
    this.logger.info(`  ‚Ä¢ –¶–µ–Ω–∞ –≤—Ö–æ–¥–∞: ${pair.shortPosition.entryPrice.toFixed(4)} USDT`);
    this.logger.info(`  ‚Ä¢ –¶–µ–Ω–∞ –≤—ã—Ö–æ–¥–∞: ${currentSellPrice.toFixed(4)} USDT`);
    this.logger.info(`  ‚Ä¢ –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ: ${pair.shortPosition.quantity.toFixed(6)} –∫–æ–Ω—Ç—Ä–∞–∫—Ç–æ–≤`);
    this.logger.info(`  ‚Ä¢ P&L: ${shortPnl.toFixed(2)}% ($${pair.shortPosition.pnl?.toFixed(2)} USD)`);
    this.logger.separator();
    this.logger.info(`üí∞ –ò—Ç–æ–≥–æ–≤—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:`);
    this.logger.info(`  ‚Ä¢ –°–ø—Ä–µ–¥ –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏: ${pair.openSpread.toFixed(2)}%`);
    this.logger.info(`  ‚Ä¢ –°–ø—Ä–µ–¥ –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏: ${pair.currentSpread?.toFixed(2) || 'N/A'}%`);
    this.logger.info(`  ‚Ä¢ –û–±—â–∞—è –ø—Ä–∏–±—ã–ª—å: ${totalPnlPercent.toFixed(2)}% ($${totalPnlUSD.toFixed(2)} USD)`);
    this.logger.info(`  ‚Ä¢ –ö–∞–ø–∏—Ç–∞–ª –≤ –ø–æ–∑–∏—Ü–∏—è—Ö –±—ã–ª: $${this.config.trading.positionSizeUSD * 2} USD`);
    this.logger.info(`  ‚Ä¢ –°—Ç–∞—Ç—É—Å: ${isProfitable ? '‚úÖ –ü–†–ò–ë–´–õ–¨' : '‚ùå –£–ë–´–¢–û–ö'}`);
    this.logger.separator();
    this.logger.info(`üìà –¢–µ–∫—É—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:`);
    this.logger.info(`  ‚Ä¢ –û—Ç–∫—Ä—ã—Ç—ã—Ö –ø–æ–∑–∏—Ü–∏–π: ${this.openPositions.size}/${this.config.trading.maxOpenPositions}`);
    this.logger.info(`  ‚Ä¢ –ó–∞–∫—Ä—ã—Ç—ã—Ö —Å–¥–µ–ª–æ–∫: ${this.closedPositions.length}`);
    this.logger.info(`  ‚Ä¢ Win Rate: ${this.getStats().winRate.toFixed(1)}%`);
    this.logger.separator('‚ïê');
  }

  /**
   * –ò–º–∏—Ç–∞—Ü–∏—è –∑–∞–∫—Ä—ã—Ç–∏—è –ø–æ–∑–∏—Ü–∏–∏ (—Ç–µ—Å—Ç–æ–≤—ã–π —Ä–µ–∂–∏–º)
   */
  private simulateClosePosition(pair: PositionPair): void {
    this.logger.info(`üß™ [TEST] –ò–º–∏—Ç–∞—Ü–∏—è –∑–∞–∫—Ä—ã—Ç–∏—è –ø–æ–∑–∏—Ü–∏–π –¥–ª—è ${pair.symbol}`);
  }

  /**
   * –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ç–∞–π–º–∞—É—Ç—ã –æ—Ç–∫—Ä—ã—Ç—ã—Ö –ø–æ–∑–∏—Ü–∏–π
   */
  private checkPositionTimeouts(): void {
    const now = Date.now();

    for (const [pairId, pair] of this.openPositions.entries()) {
      if (pair.status === 'OPEN' && now >= pair.timeoutAt) {
        this.logger.warn(
          `‚è∞ –¢–∞–π–º–∞—É—Ç –¥–ª—è ${pair.symbol} (${this.config.trading.positionTimeoutSeconds}s –∏—Å—Ç–µ–∫–ª–æ)`
        );

        // –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–∏–µ —Ä—ã–Ω–æ—á–Ω—ã–µ —Ü–µ–Ω—ã
        let buyPrice = pair.longPosition.entryPrice;
        let sellPrice = pair.shortPosition.entryPrice;

        if (this.getPricesFn) {
          const currentPrices = this.getPricesFn(pair.symbol);
          if (currentPrices) {
            buyPrice = currentPrices.buyPrice;
            sellPrice = currentPrices.sellPrice;
            this.logger.info(
              `–¢–µ–∫—É—â–∏–µ —Ä—ã–Ω–æ—á–Ω—ã–µ —Ü–µ–Ω—ã –¥–ª—è ${pair.symbol}: buy=${buyPrice.toFixed(4)}, sell=${sellPrice.toFixed(4)}`
            );
          } else {
            this.logger.warn(
              `‚ö†Ô∏è  –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å —Ç–µ–∫—É—â–∏–µ —Ü–µ–Ω—ã –¥–ª—è ${pair.symbol}, –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ü–µ–Ω—ã –≤—Ö–æ–¥–∞`
            );
          }
        } else {
          this.logger.warn(
            `‚ö†Ô∏è  –§—É–Ω–∫—Ü–∏—è –ø–æ–ª—É—á–µ–Ω–∏—è —Ü–µ–Ω –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞, –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ü–µ–Ω—ã –≤—Ö–æ–¥–∞ –¥–ª—è ${pair.symbol}`
          );
        }

        // –ó–∞–∫—Ä—ã–≤–∞–µ–º –ø–æ —Ç–µ–∫—É—â–µ–π –∏–ª–∏ –≤—Ö–æ–¥–Ω–æ–π —Ü–µ–Ω–µ
        this.closePositionPair(
          pairId,
          'TIMEOUT',
          buyPrice,
          sellPrice
        );
      }
    }
  }

  /**
   * –í—ã—á–∏—Å–ª–∏—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–æ–Ω—Ç—Ä–∞–∫—Ç–æ–≤ –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ü–µ–Ω—ã –∏ —Ä–∞–∑–º–µ—Ä–∞ –ø–æ–∑–∏—Ü–∏–∏
   */
  private calculateQuantity(price: number): number {
    return this.config.trading.positionSizeUSD / price;
  }

  /**
   * –ü–æ–ª—É—á–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É —Ç–æ—Ä–≥–æ–≤–ª–∏
   */
  getStats() {
    return {
      openPositions: this.openPositions.size,
      closedPositions: this.closedPositions.length,
      testStats: this.testStats,
      winRate:
        this.testStats.totalTrades > 0
          ? (this.testStats.profitableTrades / this.testStats.totalTrades) * 100
          : 0,
      netProfit: this.testStats.totalProfit - this.testStats.totalLoss,
    };
  }

  /**
   * –ü–æ–ª—É—á–∏—Ç—å –∑–∞–∫—Ä—ã—Ç—ã–µ –ø–æ–∑–∏—Ü–∏–∏
   */
  getClosedPositions(): PositionPair[] {
    return this.closedPositions;
  }

  /**
   * –í—ã–≤–µ—Å—Ç–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
   */
  printStats(): void {
    const stats = this.getStats();

    this.logger.separator('‚ïê');
    this.logger.info('üìä –°–¢–ê–¢–ò–°–¢–ò–ö–ê –¢–û–†–ì–û–í–õ–ò');
    this.logger.separator('‚ïê');
    this.logger.info(`–û—Ç–∫—Ä—ã—Ç—ã—Ö –ø–æ–∑–∏—Ü–∏–π: ${stats.openPositions}`);
    this.logger.info(`–ó–∞–∫—Ä—ã—Ç—ã—Ö —Å–¥–µ–ª–æ–∫: ${stats.closedPositions}`);
    this.logger.info(`–ü—Ä–∏–±—ã–ª—å–Ω—ã—Ö: ${stats.testStats.profitableTrades}`);
    this.logger.info(`–£–±—ã—Ç–æ—á–Ω—ã—Ö: ${stats.testStats.losingTrades}`);
    this.logger.info(`Win Rate: ${stats.winRate.toFixed(1)}%`);
    this.logger.info(`–û–±—â–∞—è –ø—Ä–∏–±—ã–ª—å: $${stats.testStats.totalProfit.toFixed(2)}`);
    this.logger.info(`–û–±—â–∏–π —É–±—ã—Ç–æ–∫: $${stats.testStats.totalLoss.toFixed(2)}`);
    this.logger.info(`–ß–∏—Å—Ç–∞—è –ø—Ä–∏–±—ã–ª—å: $${stats.netProfit.toFixed(2)}`);
    this.logger.separator('‚ïê');
  }

  /**
   * –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥
   */
  stop(): void {
    if (this.checkInterval) {
      clearInterval(this.checkInterval);
      this.checkInterval = null;
    }

    // –í—ã–≤–æ–¥–∏–º —Ñ–∏–Ω–∞–ª—å–Ω—É—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
    if (this.config.trading.enabled) {
      this.printStats();
    }
  }
}
